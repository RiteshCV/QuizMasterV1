{% extends "base.html" %}

{% block title %}ExamPrep Hub - {{ chapter_name }} Quizzes{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/subjects">Subjects</a></li>
            <li class="breadcrumb-item"><a href="/subjects/{{ subject_name }}">{{ subject_name }}</a></li>
            <li class="breadcrumb-item active">{{ chapter_name }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1>{{ chapter_name }} Quizzes</h1>
        {% if is_admin %}
            <button class="btn btn-primary" onclick="addNewQuiz()">Add Quiz</button>
        {% endif %}
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            {% for quiz in quizzes %}
                <div class="quiz-card mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h3 class="quiz-id mb-0">Quiz {{ quiz.id }}</h3>
                        </div>
                        <div class="col-md-5">
                            <div class="quiz-info">
                                <p class="mb-1"><strong>Opens:</strong> {{ quiz.opens_on.strftime('%Y-%m-%d %H:%M') }}</p>
                                <p class="mb-1"><strong>Closes:</strong> {{ quiz.closes_on.strftime('%Y-%m-%d %H:%M') }}</p>
                                <p class="mb-1"><strong>Duration:</strong> {{ quiz.duration }} minutes</p>
                                <p class="mb-0"><strong>Questions:</strong> {{ quiz.num_questions }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            {% if is_admin %}
                                <button class="btn me-2 border-danger text-danger" onclick="editQuiz('{{ quiz.id }}')">
                                    Edit
                                </button>
                            {% endif %}
                            <button class="btn btn-outline-primary me-2" onclick="toggleHistory('{{ quiz.id }}')">
                                History
                            </button>
                            {% if quiz.opens_on <= now and quiz.closes_on >= now %}
                                <button class="btn btn-primary" onclick="window.location.href='/subjects/{{ subject_name }}/{{ chapter_name }}/{{ quiz.id }}'">Start Quiz</button>
                            {% elif quiz.opens_on > now %}
                                <button class="btn btn-secondary" disabled>Not Open Yet</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Closed</button>
                            {% endif %}
                        </div>
                    </div>
                    <div id="history-{{ quiz.id }}" class="history-section mt-4" style="display: none;">
                        <hr>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Best Score</h5>
                                        <p class="display-4 text-success" id="best-score-{{ quiz.id }}">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Average Score</h5>
                                        <p class="display-4 text-primary" id="avg-score-{{ quiz.id }}">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Attempts</h5>
                                        <p class="display-4 text-info" id="total-attempts-{{ quiz.id }}">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Attempt History</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Score</th>
                                            <th>Time Taken</th>
                                            <th>Correct Answers</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-tbody-{{ quiz.id }}">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="editQuizModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editQuizForm">
                    <input type="hidden" id="quizId">
                    <div class="mb-3">
                        <label for="opensOn" class="form-label">Opens On</label>
                        <input type="datetime-local" class="form-control" id="opensOn" required>
                    </div>
                    <div class="mb-3">
                        <label for="closesOn" class="form-label">Closes On</label>
                        <input type="datetime-local" class="form-control" id="closesOn" required>
                    </div>
                    <div class="mb-3">
                        <label for="duration" class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control" id="duration" min="1" required>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Questions</h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addNewQuestion()">Add Question</button>
                        </div>
                        <div id="questionsContainer" class="border rounded p-3">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" onclick="deleteQuiz()">Delete Quiz</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuizChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addQuizModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQuizForm">
                    <div class="mb-3">
                        <label for="newOpensOn" class="form-label">Opens On</label>
                        <input type="datetime-local" class="form-control" id="newOpensOn" required>
                    </div>
                    <div class="mb-3">
                        <label for="newClosesOn" class="form-label">Closes On</label>
                        <input type="datetime-local" class="form-control" id="newClosesOn" required>
                    </div>
                    <div class="mb-3">
                        <label for="newDuration" class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control" id="newDuration" min="1" required>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Questions</h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addNewQuestionToNew()">Add Question</button>
                        </div>
                        <div id="newQuestionsContainer" class="border rounded p-3">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewQuiz()">Create Quiz</button>
            </div>
        </div>
    </div>
</div>

<script>
let editModal;
let addModal;
let currentQuizId;
let questions = [];
let newQuestions = [];

document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editQuizModal'));
    addModal = new bootstrap.Modal(document.getElementById('addQuizModal'));
});

function editQuiz(quizId) {
    fetch(`/api/quizzes/${quizId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        const quiz = data.quiz;
        currentQuizId = quiz.id;
        document.getElementById('quizId').value = quiz.id;
        document.getElementById('opensOn').value = quiz.opensOn;
        document.getElementById('closesOn').value = quiz.closesOn;
        document.getElementById('duration').value = quiz.duration;

        questions = quiz.questions;
        renderQuestions();
        editModal.show();
    });
}


function renderQuestions() {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = questions.map((q, index) => `
        <div class="question-item mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">Question ${index + 1}</h6>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(${index})">Remove</button>
            </div>
            <div class="mb-2">
                <input type="text" class="form-control mb-2" value="${q.question}"
                       onchange="updateQuestion(${index}, 'question', this.value)" placeholder="Question text">
            </div>
            <div class="options">
                ${q.options.map((opt, optIndex) => `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="${opt}"
                               onchange="updateOption(${index}, ${optIndex}, this.value)" placeholder="Option ${optIndex + 1}">
                        <div class="input-group-text">
                            <input type="radio" name="correct_${index}" ${q.correct_answer === optIndex ? 'checked' : ''}
                                   onchange="updateCorrectAnswer(${index}, ${optIndex})">
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function renderNewQuestions() {
    const container = document.getElementById('newQuestionsContainer');
    container.innerHTML = newQuestions.map((q, index) => `
        <div class="question-item mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">Question ${index + 1}</h6>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeNewQuestion(${index})">Remove</button>
            </div>
            <div class="mb-2">
                <input type="text" class="form-control mb-2" value="${q.question}"
                       onchange="updateNewQuestion(${index}, 'question', this.value)" placeholder="Question text">
            </div>
            <div class="options">
                ${q.options.map((opt, optIndex) => `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="${opt}"
                               onchange="updateNewOption(${index}, ${optIndex}, this.value)" placeholder="Option ${optIndex + 1}">
                        <div class="input-group-text">
                            <input type="radio" name="new_correct_${index}" ${q.correct_answer === optIndex ? 'checked' : ''}
                                   onchange="updateNewCorrectAnswer(${index}, ${optIndex})">
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function addNewQuestion() {
    questions.push({
        id: Date.now(),
        question: "",
        options: ["", "", "", ""],
        correct_answer: 0
    });
    renderQuestions();
}

function addNewQuestionToNew() {
    newQuestions.push({
        question: "",
        options: ["", "", "", ""],
        correct_answer: 0
    });
    renderNewQuestions();
}

function removeQuestion(index) {
    questions.splice(index, 1);
    renderQuestions();
}

function removeNewQuestion(index) {
    newQuestions.splice(index, 1);
    renderNewQuestions();
}

function updateQuestion(index, field, value) {
    questions[index][field] = value;
}

function updateNewQuestion(index, field, value) {
    newQuestions[index][field] = value;
}

function updateOption(index, optionIndex, value) {
    questions[index].options[optionIndex] = value;
}

function updateNewOption(index, optionIndex, value) {
    newQuestions[index].options[optionIndex] = value;
}

function updateCorrectAnswer(index, optionIndex) {
    questions[index].correct_answer = optionIndex;
}

function updateNewCorrectAnswer(index, optionIndex) {
    newQuestions[index].correct_answer = optionIndex;
}

function saveQuizChanges() {
    const formData = {
        quizId: document.getElementById('quizId').value,
        opensOn: document.getElementById('opensOn').value,
        closesOn: document.getElementById('closesOn').value,
        duration: document.getElementById('duration').value,
        questions: questions
    };

    fetch('/api/quizzes/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => { throw errorData });
        }
        return response.json();
    })
    .then(data => {
        console.log('Quiz updated:', data);
        editModal.hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error updating quiz:', error);
        alert('Error updating quiz: ' + (error.error || 'Unknown error'));
    });
}

function deleteQuiz() {
    if (confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
        console.log('Deleting quiz:', currentQuizId);
        fetch('/api/quizzes/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ currentQuizId: currentQuizId })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => { throw errorData });
            }
            return response.json();
        })
        .then(data => {
            console.log('Quiz deleted:', data);
            editModal.hide();
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting quiz:', error);
            alert('Error deleting quiz: ' + (error.error || 'Unknown error'));
        });
    }
}

function saveNewQuiz() {
    const formData = {
        opensOn: document.getElementById('newOpensOn').value,
        closesOn: document.getElementById('newClosesOn').value,
        duration: document.getElementById('newDuration').value,
        questions: newQuestions,
        chapterName: "{{ chapter_name }}"
    };

    fetch('/api/quizzes/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => { throw errorData });
        }
        return response.json();
    })
    .then(data => {
        console.log('Quiz created:', data);
        addModal.hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error creating quiz:', error);
        alert('Error creating quiz: ' + (error.error || 'Unknown error'));
    });
}

function addNewQuiz() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);

    document.getElementById('newOpensOn').value = now.toISOString().slice(0, 16);
    document.getElementById('newClosesOn').value = tomorrow.toISOString().slice(0, 16);
    document.getElementById('newDuration').value = 60;
    newQuestions = [];
    renderNewQuestions();

    addModal.show();
}

async function toggleHistory(quizId) {
    const historySection = document.getElementById(`history-${quizId}`);
    const isHidden = historySection.style.display === 'none';

    if (isHidden) {
        try {
            const response = await fetch(`/quiz/${quizId}/history`);
            const data = await response.json();
            const bestScoreElement = document.getElementById(`best-score-${quizId}`);
            const avgScoreElement = document.getElementById(`avg-score-${quizId}`);
            const scores = data.map(h => h.score).filter(score => !isNaN(score));
            const bestScore = scores.length ? Math.max(...scores) + '%' : '-';
            const avgScore = scores.length ? (scores.reduce((sum, score) => sum + score, 0) / scores.length).toFixed(1) + '%' : '-';
            bestScoreElement.textContent = bestScore;
            avgScoreElement.textContent = avgScore;
            document.getElementById(`total-attempts-${quizId}`).textContent = data.length;
            const tbody = document.getElementById(`history-tbody-${quizId}`);

            tbody.innerHTML = data.map(attempt => `
                <tr>
                    <td>${new Date(attempt.attempt_date).toLocaleString()}</td>
                    <td>
                        <span class="badge bg-${attempt.score >= 80 ? 'success' : attempt.score >= 60 ? 'warning' : 'danger'}">
                            ${attempt.score}%
                        </span>
                    </td>
                    <td>${attempt.time_taken} minutes</td>
                    <td>${attempt.correct_answers}/${attempt.total_questions}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching history:', error);
        }
    }

    historySection.style.display = isHidden ? 'block' : 'none';
}
</script>
{% endblock %}